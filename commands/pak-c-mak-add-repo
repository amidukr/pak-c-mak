#!/bin/bash
set -e

if [ "$#" -ne 3 ]; then 
	"$PAK_C_MAK_PATH/commands/pak-c-mak-help"
	exit 1;
fi

REPO=$1
GIT_URL=$2
GIT_BRANCH=$3

REPO_DIR=$("$PAK_C_MAK_PATH/tools/find-downloaded-content" repos $REPO)
"$PAK_C_MAK_PATH/tools/download-git-clone" repos $REPO "$GIT_URL" $GIT_BRANCH
mkdir -p "$PAK_C_MAK_PATH/packages/" 
cp -rf "$REPO_DIR"/packages/* "$PAK_C_MAK_PATH/packages/" 

if [ -d "$REPO_DIR/profiles" ]; then
	mkdir -p "$PAK_C_MAK_PATH/profiles/"
	cp -rf "$REPO_DIR"/profiles/* "$PAK_C_MAK_PATH/profiles/";
fi

mkdir -p "$PAK_C_MAK_PATH/repositories"

echo \
"REPO=${REPO}
GIT_URL=${GIT_URL}
GIT_BRANCH=${GIT_BRANCH}" >"$PAK_C_MAK_PATH/repositories/repo-meta-${REPO}"

if [ -f "$PAK_C_MAK_PATH/repositories/repo-list" ]; then
	REPO_LIST=$(cat "$PAK_C_MAK_PATH/repositories/repo-list")
	
fi

REPO_LIST=$(echo "$REPO_LIST" | grep -Fvx $REPO)
echo "$REPO_LIST"$'\n'"$REPO" > "$PAK_C_MAK_PATH/repositories/repo-list"
sed -i '/^$/d' "$PAK_C_MAK_PATH/repositories/repo-list"

cat "$PAK_C_MAK_PATH/repositories/repo-list"
